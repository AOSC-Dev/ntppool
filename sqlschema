-- the static part: the servers etc.

CREATE TABLE users (
    id SERIAL NOT NULL UNIQUE,
    email varchar(255) NOT NULL UNIQUE,
    name varchar(255),
    pass varchar(255),
    nomail enum('0','1') not null default '0'
) engine=INNODB;

CREATE TABLE servers (
    id SERIAL NOT NULL UNIQUE,
    ip varchar(15) NOT NULL PRIMARY KEY,
    admin INTEGER NOT NULL REFERENCES users (id),
    hostname TEXT
) engine=INNODB;
GRANT SELECT ON servers TO "www-data";

CREATE TABLE zones (
    id SERIAL NOT NULL PRIMARY KEY,
    name varchar(255) NOT NULL UNIQUE
);

CREATE TABLE locations (
    server INTEGER NOT NULL REFERENCES servers (id) ON DELETE CASCADE,
    zone INTEGER NOT NULL REFERENCES zones (id),
    UNIQUE (server, zone)
);

-- the dynamic part: logging
CREATE TABLE log_scores (
    server INTEGER NOT NULL REFERENCES servers (id) ON DELETE CASCADE,
    ts timestamp NOT NULL,
    score REAL NOT NULL,
    step REAL NOT NULL,
    offs REAL -- abs(offset)
);
CREATE INDEX log_scores_server_ts_idx ON log_scores (server,ts);

-- this is a different table from 'servers' since it changes a lot
-- and in a different table from 'log' as we only store the current score
CREATE TABLE scores (
    server INTEGER NOT NULL UNIQUE REFERENCES servers(id) ON DELETE CASCADE,
    ts TIMESTAMP not null,
    score REAL NOT NULL DEFAULT 0.0
);
GRANT SELECT ON log_scores TO "www-data";

-- integrating automatic checking/reporting of unreachable servers
CREATE TABLE unusable_servers (
    server INTEGER NOT NULL REFERENCES servers (id) ON DELETE CASCADE,
    last_score REAL NOT NULL DEFAULT 0.0,
    last_email_time datetime,
    ts TIMESTAMP not null
);

-- populate the db with the zones
COPY zones (id, name) FROM stdin;
1	europe
2	asia
3	oceania
4	north-america
5	at
6	au
7	ca
8	ch
9	de
10	dk
11	es
12	fr
13	it
14	lu
15	nl
16	no
17	nz
18	ph
19	pl
20	se
21	si
22	uk
23	us
24	my
25	mx
26	fi
27	ie
28	br
29	south-america
30	ru
31	tr
32	sg
33	cl
34	in
35	hk
36	ae
37	be
38	pt
39	jp
40	gt
41	bd
42	il
43	kr
44	gr
45	hu
46	bg
\.

#SELECT pg_catalog.setval ('zones_id_seq', 46, true);

