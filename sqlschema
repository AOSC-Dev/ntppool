-- the static part: the servers etc.

alter database default character set 'utf8';

CREATE TABLE users (
    id int unsigned primary key auto_increment,
    email varchar(255) NOT NULL UNIQUE,
    name varchar(255),
    pass varchar(255),
    nomail enum('0','1') not null default '0'
) engine=INNODB;

CREATE TABLE servers (
    id int unsigned primary key auto_increment,
    ip varchar(15) NOT NULL unique,
    admin INTEGER NOT NULL REFERENCES users (id),
    hostname TEXT
) engine=INNODB;
-- GRANT SELECT ON servers TO "www-data";

CREATE TABLE zones (
    id SERIAL NOT NULL PRIMARY KEY,
    name varchar(255) NOT NULL UNIQUE
) ENGINE=INNODB;

CREATE TABLE locations (
    id int unsigned primary key auto_increment,
    server INTEGER NOT NULL REFERENCES servers (id) ON DELETE CASCADE,
    zone INTEGER NOT NULL REFERENCES zones (id),
    UNIQUE (server, zone)
) ENGINE=INNODB;

-- the dynamic part: logging
CREATE TABLE log_scores (
    server INTEGER NOT NULL REFERENCES servers (id) ON DELETE CASCADE,
    ts timestamp NOT NULL,
    score REAL NOT NULL,
    step REAL NOT NULL,
    offs REAL -- abs(offset)
) ENGINE=INNODB;
CREATE INDEX log_scores_server_ts_idx ON log_scores (server,ts);

-- this is a different table from 'servers' since it changes a lot
-- and in a different table from 'log' as we only store the current score
CREATE TABLE scores (
    server INTEGER NOT NULL UNIQUE REFERENCES servers(id) ON DELETE CASCADE,
    ts TIMESTAMP not null,
    score REAL NOT NULL DEFAULT 0.0
) ENGINE=INNODB;

-- GRANT SELECT ON log_scores TO "www-data";

-- integrating automatic checking/reporting of unreachable servers
CREATE TABLE unusable_servers (
    server INTEGER NOT NULL REFERENCES servers (id) ON DELETE CASCADE,
    last_score REAL NOT NULL DEFAULT 0.0,
    last_email_time datetime,
    ts TIMESTAMP not null
) ENGINE=INNODB;


CREATE TABLE `zone_server_counts` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `zone` bigint(20) unsigned NOT NULL,
  `date` date NOT NULL,
  `count_active` mediumint(8) unsigned NOT NULL,
  `count_all` mediumint(8) unsigned NOT NULL,
  PRIMARY KEY  (`id`),
  UNIQUE KEY `zone` (`zone`,`date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


